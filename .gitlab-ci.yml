include:
  - project: 'zl0i/gitlab-ci-template'
    ref: main
    file: 'build.template.yaml'
  - project: 'zl0i/gitlab-ci-template'
    ref: main
    file: 'deploy.template.yaml'
  - project: 'zl0i/gitlab-ci-template'
    ref: main
    file: 'release.template.yaml'
  - template: Code-Quality.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - template: 'Verify/Accessibility.gitlab-ci.yml'
  - template: Security/Container-Scanning.gitlab-ci.yml

stages:
  - build
  - test
  - release
  - deploy
  - accessibility

variables:
  SCAN_KUBERNETES_MANIFESTS: 'true'

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
      variables:
        SAST_DISABLED: 'false'
    - if: $CI_COMMIT_BRANCH == "dev"
      variables:
        SAST_DISABLED: 'true'
    - if: $CI_COMMIT_TAG
      variables:
        SAST_DISABLED: 'true'

code_quality:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"

container_scanning:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
  variables:
    SECURE_LOG_LEVEL: 'debug'
    DOCKER_IMAGE: $CI_REGISTRY_IMAGE/zloi-web:$CI_COMMIT_SHORT_SHA

build:web:
  extends: .kaniko
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.zloi.space'
        IMAGE_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == 'dev'
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.${CI_COMMIT_BRANCH}.zloi.space'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.${CI_ENVIRONMENT_SLUG}.zloi.space'
  variables:
    BUILD_DIR: './web'
    IMAGE_NAME: zloi-web
  after_script:
    - export

build:admin:
  extends: .kaniko
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.zloi.space'
        IMAGE_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == 'dev'
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.${CI_COMMIT_BRANCH}.zloi.space'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
      variables:
        BUILD_ARGS: '--build-arg API_URL=https://api.${CI_ENVIRONMENT_SLUG}.zloi.space'
  variables:
    BUILD_DIR: './admin'
    IMAGE_NAME: zloi-admin

build:api:
  extends: .kaniko
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == 'dev'
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
  variables:
    BUILD_DIR: './api'
    IMAGE_NAME: zloi-api

deploy:review:
  extends: .helm_install
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
  environment:
    name: review/${CI_ENVIRONMENT_SLUG}
    url: https://${CI_ENVIRONMENT_SLUG}.zloi.space
    deployment_tier: testing
    on_stop: stop:review:deploy
    auto_stop_in: 1 week
  variables:
    HELM_OPTIONS: '--set ingress.basehost=${CI_ENVIRONMENT_SLUG}.zloi.space
      --set api.adminKey=${ADMIN_KEY}'

deploy:dev:
  extends: .helm_install
  rules:
    - if: $CI_COMMIT_BRANCH == 'dev'
  environment:
    name: ${CI_COMMIT_BRANCH}
    url: https://${CI_COMMIT_BRANCH}.zloi.space
    deployment_tier: development
  variables:
    HELM_OPTIONS: '--set ingress.basehost=${CI_COMMIT_BRANCH}.zloi.space
      --set api.adminKey=${ADMIN_KEY}'

deploy:production:
  extends: .helm_install
  rules:
    - if: $CI_COMMIT_TAG
  environment:
    name: production
    url: https://zloi.space
    deployment_tier: production
  variables:
    IMAGE_TAG: $CI_COMMIT_TAG
    HELM_OPTIONS: '--set api.adminKey=${ADMIN_KEY}
      --set ingress.basehost=zloi.space
      --set web.autoscaling.enabled=true
      --set priorityclass.enabled=true'

stop:review:deploy:
  extends: .helm_uninstall
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"
  environment:
    name: review/${CI_ENVIRONMENT_SLUG}
    action: stop
  variables:
    DELETE_NAMESPACE: 'true'
  when: manual

a11y:
  rules:
    - if: $CI_COMMIT_TAG
      variables:
        a11y_urls: 'https://zloi.space'
    - if: $CI_COMMIT_BRANCH && $CI_COMMIT_BRANCH != 'master'
      variables:
        a11y_urls: 'https://${CI_COMMIT_BRANCH}.zloi.space'
